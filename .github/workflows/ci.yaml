name: CI

on:
    push:
    pull_request:

jobs:
    test:
        runs-on: ubuntu-latest
        name: PHPUnit Tests
        strategy:
            fail-fast: false
            matrix:
                php: [ '8.1', '8.2', '8.3', '8.4' ]
                monolog: [ '2.*' ]
                symfony: [ false ]
                extensions: [ '' ]
                include:
                    -   php: '8.1'
                        deps: lowest
                        symfony: '6.4.*'
                        monolog: '1.*'
                        deprecations: max[self]=0
                    -   php: '8.1'
                        monolog: '3.*'
                        symfony: '6.4.*'
                    -   php: '8.4'
                        deps: highest
                        monolog: '3.*'
                    -   php: '8.4'
                        extensions: mongodb

        env:
            SYMFONY_REQUIRE: ${{ matrix.symfony }}

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: ${{ matrix.php }}
                    ini-values: zend.exception_ignore_args=false
                    tools: flex
                    extensions: ${{ matrix.extensions }}

            -   name: Configure composer
                if: "${{ matrix.deps == 'highest' }}"
                run: composer config minimum-stability dev

            -   name: Require Monolog version
                if: "${{ matrix.monolog != '' }}"
                run: composer require --no-update monolog/monolog:${{ matrix.monolog }}

            -   name: Require mongodb/mongodb if ext-mongodb is available
                if: "${{ contains(matrix.extensions, 'mongodb') }}"
                run: composer require --no-update mongodb/mongodb

            -   name: Composer install
                uses: ramsey/composer-install@v3
                with:
                    dependency-versions: '${{ matrix.deps }}'

            -   name: Install PHPUnit dependencies
                run: vendor/bin/simple-phpunit install

            -   name: Run tests
                run: vendor/bin/simple-phpunit -v --coverage-text
                env:
                    SYMFONY_DEPRECATIONS_HELPER: '${{ matrix.deprecations }}'
